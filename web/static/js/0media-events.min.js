var x$;function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}(x$=angular.module("0media.events",[])).controller("0media.events.main",["$scope","$interval","$timeout","$http","0media.events.map","0media.events.map-style"].concat(function(l,t,p,e,c,n){var d,m,f;return l.style="default",d=$("#zm-event .eventmap"),l.dim={width:0,height:0,wtype:"w-md",htype:"h-md",timelineHeight:300},m=function(){return l.$apply(function(){var t=[d.width(),d.height()],e=t[0],n=t[1];return(t=l.dim).width=e,t.height=n,l.dim.wtype=e<=480?"w-mc":e<=768?"w-xs":e<=991?"w-sm":e<=1199?"w-md":"w-lg",l.dim.htype=n<=240?"h-mc":n<=320?"h-xs":n<=480?"h-sm":n<=600?"h-md":"h-lg",l.dim.timelineHeight={"h-mc":120,"h-xs":140,"h-sm":200,"h-md":300,"h-lg":300}[l.dim.htype]})},f={onAdd:function(t,e){var n=$("#zm-event .bubbles")[0];return n.parentNode.removeChild(n),e.appendChild(n)},draw:function(r,t){var o=Math.pow(2,t.getZoom()-6);return l.events.map(function(t,e){var n;return t.x=(n=r.ll2p(t.lat,t.lng)).x,t.y=n.y,t.rate=o})}},l.reset=function(n){return null==n&&(n=!1),l.events.top=5,l.stepCount=0,l.events.map(function(t,e){return t.fadeout=1,t.opacity=.8,t.size=0,t.circle_opacity=0,t.bubble={},t.first=!1,n||(t.top=50*e),t})},l.setStyle=function(t){return l.style=t,l.map.set("styles",n[t])},l.play=function(){return l.state=1,l.dir=1},l.pause=function(){return l.state=0},l.speeding=function(){return l.speed=l.speed%3+1},l.step=function(t){return t!==l.dir&&l.events.map(function(t,e){return t.bubble={state:0},t.size=0,t.circle_opacity=0,t}),l.dir=t,l.state=2},l.state=1,l.speed=3,l.dir=1,l.loaded="loading",l.initData=function(){var n,r,u={src:"1yY4pqGqI3rLMf5bQqe5XMztnnJ78RMUrfh-XpJdhd_o",color:"default",ratio:1};return((window.location.search||"").split("?").filter(function(t){return t})[0]||"").split("&").map(function(t){t=t.split("=");return u[t[0]]=t[1]}),l.$parent.config&&import$(u,l.$parent.config),l.currentURL=u.currentURL||"http://0media.tw/t/geoevent/widget/?"+function(){var t,e=[];for(n in t=u)r=t[n],e.push([n,r]);return e}().filter(function(t){return t[0]&&void 0!==t[1]}).map(function(t){return t[0]+"="+encodeURIComponent(t[1])}).join("&"),e({url:"https://spreadsheets.google.com/feeds/worksheets/"+u.src+"/public/full?alt=json",method:"GET"}).success(function(t){return l.title=t.feed.title.$t,e({url:"https://spreadsheets.google.com/feeds/list/"+u.src+"/1/public/values?alt=json",method:"GET"}).success(function(e){var s,n,i,r,t,o,a;return console.log(e),s=function(){var t=[];for(n in e.feed.entry[0])t.push(n);return t}().map(function(t){return/^gsx\$mag1-(.+)$/.exec(t)}).filter(function(t){return t})[0],i=function(){var t=[];for(n in e.feed.entry[0])t.push(n);return t}().map(function(t){return/^gsx\$mag2-(.+)$/.exec(t)}).filter(function(t){return t})[0],console.log(function(){var t=[];for(n in e.feed.entry[0])t.push(n);return t}()),l.mag1=s?s[1]:"death",l.mag2=i?i[1]:"hurt",s=s?s[0]:"gsx$death",i=i?i[0]:"gsx$wounded",console.log(l.mag1,l.mag2),t=(r=(r=e.feed.entry.map(function(t){var e,n,r,o,a=t.gsx$date.$t.replace(/[年月]/g,"/");return a=a.replace(/[日]/g,""),n=(e=new Date(a)).getMonth()+1,a=e.getYear()+1900+"/"+(n<10?"0":"")+n,(n={mag1:parseInt((t[s]||(t[s]={})).$t||0),mag2:parseInt((t[i]||(t[i]={})).$t||0)}).total=n.mag1+n.mag2,n.radius=3*parseInt(Math.sqrt(n.total))+10,r=parseFloat(t.gsx$latitude.$t||0),o=parseFloat(t.gsx$longitude.$t||0),{name:(t.gsx$shortname.$t||t.gsx$event.$t).trim(),dateFull:e,magsum:n,lat:r,lng:o,loc:new google.maps.LatLng(r,o),date:a}})).filter(function(t){return t.lat&&t.lng&&t.magsum.total})).map(function(t){return parseFloat(t.lat)}).sort(function(t,e){return t-e}),o=r.map(function(t){return parseFloat(t.lng)}).sort(function(t,e){return t-e}),l.stepCount=0,p(a=function(){var t;return l.state&&((t=r[l.stepCount+l.dir])&&(t.circle_opacity=1,t.bubble.state=1,t.size=t.magsum.radius*t.rate*u.ratio),t&&(l.current=t),(t=r[l.stepCount])&&(t.bubble.state=2),(t=r[l.stepCount-l.dir])&&(t.circle_opacity=0),l.events.top=(l.events.top||5)-50*l.dir,5<l.events.top&&(l.events.top=5,l.state=0),l.events.top<5-50*(l.events.length-1)&&(l.events.top=5-50*(l.events.length-1),l.state=0),l.stepCount+=l.dir,0<=l.stepCount||(l.stepCount=0),l.stepCount<=(t=l.events.length-1)||(l.stepCount=t)),2===l.state&&(l.state=0),p(a,[1600,800,300][l.speed-1])},0),l.events=r,l.reset(),l.map=c.init(d[0],[t[0],t[t.length-1]],[o[0],o[o.length-1]],m,f,u),l.setStyle(u.color),l.loaded="",setTimeout(m,0)})})},l.initData()}));